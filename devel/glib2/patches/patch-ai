$NetBSD: patch-ai,v 1.15 2008/09/06 11:07:20 obache Exp $

--- glib/gmain.c.orig	2008-09-02 15:09:41.000000000 +0000
+++ glib/gmain.c
@@ -2717,13 +2717,13 @@ g_main_context_iterate (GMainContext *co
     {
       gboolean got_ownership;
       
+      LOCK_CONTEXT (context);
+
       g_return_val_if_fail (g_thread_supported (), FALSE);
 
       if (!block)
 	return FALSE;
 
-      LOCK_CONTEXT (context);
-      
       if (!context->cond)
 	context->cond = g_cond_new ();
           
@@ -2733,7 +2733,6 @@ g_main_context_iterate (GMainContext *co
 
       if (!got_ownership)
 	{
-	  UNLOCK_CONTEXT (context);
 	  return FALSE;
 	}
     }
