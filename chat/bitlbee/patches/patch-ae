$NetBSD: patch-ae,v 1.2 2008/04/20 09:31:05 tonio Exp $

Fix stalling issue with OpenSSL and Jabber
From http://bugs.bitlbee.org/bitlbee/changeset/devel%2C359

--- protocols/jabber/io.c.orig	Sat Feb 16 23:39:47 2008
+++ protocols/jabber/io.c
@@ -240,8 +240,13 @@ static gboolean jabber_read_callback( gp
 		return FALSE;
 	}
 	
-	/* EAGAIN/etc or a successful read. */
-	return TRUE;
+	if( ssl_pending( jd->ssl ) )
+		/* OpenSSL empties the TCP buffers completely but may keep some
+		   data in its internap buffers. select() won't see that, but
+		   ssl_pending() does. */
+		return jabber_read_callback( data, fd, cond );
+	else
+		return TRUE;
 }
 
 gboolean jabber_connected_plain( gpointer data, gint source, b_input_condition cond )
