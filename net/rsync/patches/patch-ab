$NetBSD: patch-ab,v 1.11 2008/03/09 20:56:57 bjs Exp $

--- Makefile.in.orig	2008-02-12 20:29:09.000000000 -0500
+++ Makefile.in
@@ -13,6 +13,7 @@ CFLAGS=@CFLAGS@
 CPPFLAGS=@CPPFLAGS@
 EXEEXT=@EXEEXT@
 LDFLAGS=@LDFLAGS@
+LTCFLAGS?= -prefer-pic
 
 INSTALLCMD=@INSTALL@
 INSTALLMAN=@INSTALL@
@@ -54,26 +55,27 @@ CHECK_SYMLINKS = testsuite/chown-fake.te
 CHECK_OBJS=tls.o getgroups.o getfsdev.o t_stub.o t_unsafe.o trimslash.o wildtest.o
 
 # note that the -I. is needed to handle config.h when using VPATH
+LTOBJ_SAVE= $(OBJ_RESTORE:%.o.sav=%.lo.sav)
+LTOBJ_RESTORE= $(OBJ_SAVE:.o=.lo)
 .c.o:
 @OBJ_SAVE@
-	$(CC) -I. -I$(srcdir) $(CFLAGS) $(CPPFLAGS) -c $< @CC_SHOBJ_FLAG@
-@OBJ_RESTORE@
+	$(LIBTOOL) --mode=compile --tag=CC $(CC) -I. -I$(srcdir) $(CFLAGS) $(LTCFLAGS) $(CPPFLAGS) -c $< -o $(@:.o=.lo) $(LTOBJ_RESTORE)
 
 all: conf_stop make_stop rsync$(EXEEXT) @MAKE_MAN@
 
 install: all
-	-mkdir -p ${DESTDIR}${bindir}
-	${INSTALLCMD} ${INSTALL_STRIP} -m 755 rsync$(EXEEXT) ${DESTDIR}${bindir}
-	-mkdir -p ${DESTDIR}${mandir}/man1
-	-mkdir -p ${DESTDIR}${mandir}/man5
-	if test -f $(srcdir)/rsync.1; then ${INSTALLMAN} -m 644 $(srcdir)/rsync.1 ${DESTDIR}${mandir}/man1; fi
-	if test -f $(srcdir)/rsyncd.conf.5; then ${INSTALLMAN} -m 644 $(srcdir)/rsyncd.conf.5 ${DESTDIR}${mandir}/man5; fi
+	${BSD_INSTALL_PROGRAM_DIR} ${DESTDIR}${bindir}
+	${LIBTOOL} --mode=install ${BSD_INSTALL_PROGRAM} ${INSTALL_STRIP} rsync$(EXEEXT) ${DESTDIR}${bindir}
+	${BSD_INSTALL_MAN_DIR} ${DESTDIR}${mandir}/man1
+	${BSD_INSTALL_MAN_DIR} ${DESTDIR}${mandir}/man5
+	if test -f $(srcdir)/rsync.1; then ${BSD_INSTALL_MAN} $(srcdir)/rsync.1 ${DESTDIR}${mandir}/man1; fi
+	if test -f $(srcdir)/rsyncd.conf.5; then ${BSD_INSTALL_MAN} $(srcdir)/rsyncd.conf.5 ${DESTDIR}${mandir}/man5; fi
 
 install-strip:
 	$(MAKE) INSTALL_STRIP='-s' install
 
 rsync$(EXEEXT): $(OBJS)
-	$(CC) $(CFLAGS) $(LDFLAGS) -o $@ $(OBJS) $(LIBS)
+	$(LIBTOOL) --mode=link $(CC) $(CFLAGS) $(LDFLAGS) -o $@ $(OBJS:.o=.lo) $(LIBS)
 
 $(OBJS): $(HEADERS)
 $(CHECK_OBJS): $(HEADERS)
@@ -82,7 +84,7 @@ flist.o: rounding.h
 
 rounding.h: rounding.c rsync.h
 	@for r in 0 1 3; do \
-	    if $(CC) $(CFLAGS) $(LDFLAGS) -o rounding -DEXTRA_ROUNDING=$$r -I. $(srcdir)/rounding.c >/dev/null 2>&1; then \
+	    if $(LIBTOOL) --mode=link $(CC) $(CFLAGS) $(LDFLAGS) -o rounding -DEXTRA_ROUNDING=$$r -I. $(srcdir)/rounding.c >/dev/null 2>&1; then \
 		echo "#define EXTRA_ROUNDING $$r" >rounding.h; \
 		if test -f "$$HOME/build_farm/build_test.fns"; then \
 		    echo "EXTRA_ROUNDING is $$r" >&2; \
@@ -97,21 +99,21 @@ rounding.h: rounding.c rsync.h
 	fi
 
 tls$(EXEEXT): $(TLS_OBJ)
-	$(CC) $(CFLAGS) $(LDFLAGS) -o $@ $(TLS_OBJ) $(LIBS)
+	$(LIBTOOL) --mode=link $(CC) $(CFLAGS) $(LDFLAGS) -o $@ $(TLS_OBJ:.o=.lo) $(LIBS)
 
 getgroups$(EXEEXT): getgroups.o
-	$(CC) $(CFLAGS) $(LDFLAGS) -o $@ getgroups.o $(LIBS)
+	$(LIBTOOL) --mode=link $(CC) $(CFLAGS) $(LDFLAGS) -o $@ getgroups.lo $(LIBS)
 
 getfsdev$(EXEEXT): getfsdev.o
-	$(CC) $(CFLAGS) $(LDFLAGS) -o $@ getfsdev.o $(LIBS)
+	$(LIBTOOL) --mode=link $(CC) $(CFLAGS) $(LDFLAGS) -o $@ getfsdev.lo $(LIBS)
 
 TRIMSLASH_OBJ = trimslash.o syscall.o lib/compat.o lib/snprintf.o
 trimslash$(EXEEXT): $(TRIMSLASH_OBJ)
-	$(CC) $(CFLAGS) $(LDFLAGS) -o $@ $(TRIMSLASH_OBJ) $(LIBS)
+	$(LIBTOOL) --mode=link $(CC) $(CFLAGS) $(LDFLAGS) -o $@ $(TRIMSLASH_OBJ:.o=.lo) $(LIBS)
 
 T_UNSAFE_OBJ = t_unsafe.o syscall.o util.o t_stub.o lib/compat.o lib/snprintf.o
 t_unsafe$(EXEEXT): $(T_UNSAFE_OBJ)
-	$(CC) $(CFLAGS) $(LDFLAGS) -o $@ $(T_UNSAFE_OBJ) $(LIBS)
+	$(LIBTOOL) --mode=link $(CC) $(CFLAGS) $(LDFLAGS) -o $@ $(T_UNSAFE_OBJ:.o=.lo) $(LIBS)
 
 gen: conf proto.h man
 
@@ -209,9 +211,10 @@ check: all $(CHECK_PROGS) $(CHECK_SYMLIN
 check29: all $(CHECK_PROGS) $(CHECK_SYMLINKS)
 	rsync_bin=`pwd`/rsync$(EXEEXT) $(srcdir)/runtests.sh --protocol=29
 
+LT_BUILD_POPT= $(BUILD_POPT:.o=.lo)
 wildtest.o: wildtest.c lib/wildmatch.c rsync.h config.h
 wildtest$(EXEEXT): wildtest.o lib/compat.o lib/snprintf.o @BUILD_POPT@
-	$(CC) $(CFLAGS) $(LDFLAGS) -o $@ wildtest.o lib/compat.o lib/snprintf.o @BUILD_POPT@ $(LIBS)
+	$(LIBTOOL) --mode=link $(CC) $(CFLAGS) $(LDFLAGS) -o $@ wildtest.lo lib/compat.lo lib/snprintf.lo $(LT_BUILD_POPT) $(LIBS)
 
 testsuite/chown-fake.test:
 	ln -s chown.test $(srcdir)/testsuite/chown-fake.test
