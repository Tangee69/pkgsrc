$NetBSD: patch-ac,v 1.4 2008/04/23 09:44:05 tnn Exp $

--- pixman/pixman-pict.c.orig	2008-03-27 11:58:20.000000000 +0100
+++ pixman/pixman-pict.c
@@ -1428,6 +1428,8 @@ static const FastPathInfo mmx_fast_paths
 
     { PIXMAN_OP_SRC, PIXMAN_a8r8g8b8,  PIXMAN_null,	PIXMAN_a8r8g8b8, fbCompositeCopyAreammx, 0 },
     { PIXMAN_OP_SRC, PIXMAN_a8b8g8r8,  PIXMAN_null,	PIXMAN_a8b8g8r8, fbCompositeCopyAreammx, 0 },
+    { PIXMAN_OP_SRC, PIXMAN_a8r8g8b8,  PIXMAN_null,	PIXMAN_x8r8g8b8, fbCompositeCopyAreammx, 0 },
+    { PIXMAN_OP_SRC, PIXMAN_a8b8g8r8,  PIXMAN_null,	PIXMAN_x8b8g8r8, fbCompositeCopyAreammx, 0 },
     { PIXMAN_OP_SRC, PIXMAN_x8r8g8b8,  PIXMAN_null,	PIXMAN_x8r8g8b8, fbCompositeCopyAreammx, 0 },
     { PIXMAN_OP_SRC, PIXMAN_x8b8g8r8,  PIXMAN_null,	PIXMAN_x8b8g8r8, fbCompositeCopyAreammx, 0 },
     { PIXMAN_OP_SRC, PIXMAN_r5g6b5,    PIXMAN_null,     PIXMAN_r5g6b5,   fbCompositeCopyAreammx, 0 },
@@ -1751,7 +1753,7 @@ pixman_image_composite (pixman_op_t     
 }
 
 
-#ifdef USE_MMX
+#if defined(USE_MMX) || defined(USE_SSE2)
 /* The CPU detection code needs to be in a file not compiled with
  * "-mmmx -msse", as gcc would generate CMOV instructions otherwise
  * that would lead to SIGILL instructions on old CPUs that don't have
@@ -1933,6 +1935,7 @@ static unsigned int detectCPUFeatures(vo
     return features;
 }
 
+#ifdef USE_MMX
 pixman_bool_t
 pixman_have_mmx (void)
 {
@@ -1948,6 +1951,7 @@ pixman_have_mmx (void)
 
     return mmx_present;
 }
+#endif
 
 #ifdef USE_SSE2
 pixman_bool_t
