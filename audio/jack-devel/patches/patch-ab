$NetBSD: patch-ab,v 1.3 2008/04/08 01:44:47 bjs Exp $

The default watchdog timeout is 10 seconds, which is too much for
usleep().  Let's nanosleep if it's available.

--- jackd/engine.c.orig	2008-03-17 18:26:49.000000000 -0400
+++ jackd/engine.c
@@ -907,12 +907,24 @@ jack_engine_post_process (jack_engine_t 
 static void *
 jack_watchdog_thread (void *arg)
 {
+#ifdef nanosleep
+	struct timespec ts;
+#endif
 	jack_engine_t *engine = (jack_engine_t *) arg;
 
 	engine->watchdog_check = 0;
+#ifdef nanosleep
+	ts.tv_sec = JACKD_WATCHDOG_TIMEOUT / 1000;
+	ts.tv_nsec = (JACKD_WATCHDOG_TIMEOUT - (ts.tv_sec * 1000)) * 1000;
+#endif
+
 
 	while (1) {
+#ifdef nanosleep
+		nanosleep(&ts, NULL);
+#else
 		usleep (1000 * JACKD_WATCHDOG_TIMEOUT);
+#endif
 		if (!engine->freewheeling && engine->watchdog_check == 0) {
 
 			jack_error ("jackd watchdog: timeout - killing jackd");
@@ -1468,7 +1480,7 @@ jack_server_thread (void *arg)
 				    (engine, pfd[i].fd)) {
 					jack_error ("could not handle external"
 						    " client request");
-#ifdef JACK_USE_MACH_THREADS
+#ifdef JACK_HOST_HAS_BSD_POLL
                                     /* poll is implemented using
 				       select (see the macosx/fakepoll
 				       code). When the socket is closed
@@ -1481,7 +1493,7 @@ jack_server_thread (void *arg)
 				       and remove the client.
                                     */
                                     jack_client_disconnect(engine, pfd[i].fd);
-#endif /* JACK_USE_MACH_THREADS */
+#endif /* JACK_HOST_HAS_BSD_POLL */
 				}
 			}
 		}
