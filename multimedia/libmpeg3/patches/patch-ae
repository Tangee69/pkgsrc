$NetBSD: patch-ae,v 1.12 2009/01/24 12:29:51 tonio Exp $

--- mpeg3io.c.orig	2005-05-01 07:57:56.000000000 +0200
+++ mpeg3io.c
@@ -1,11 +1,34 @@
 #include "mpeg3private.h"
 #include "mpeg3protos.h"
 
-#include <mntent.h>
 #include <stdint.h>
 #include <stdlib.h>
 #include <string.h>
-#include <sys/stat.h>
+
+#if defined(__NetBSD__) || defined(__DragonFly__) || (defined(__APPLE__) && defined(__MACH__))
+# include <sys/param.h>
+# include <sys/mount.h>
+
+# if defined(__APPLE__) && defined(__MACH__)
+#include <sys/cdefs.h>
+# endif
+# if (defined(__NetBSD__) && __NetBSD_Version__ >= 299000900 /* 2.99.9 */) || defined(__DragonFly__) || (defined(__APPLE__) && defined(__MACH__))
+#  define fopen64 fopen
+#  define fseeko64 fseek
+#  if (defined(__APPLE__) && defined(__MACH__) && !defined(__DARWIN_64_BIT_INO_T) /* MacOSX < 10.5 */)
+#  define stat64 stat
+#  endif
+# endif
+# if defined(__NetBSD__) && __NetBSD_Version__ >= 299000900 /* 2.99.9 */
+#  define statfs statvfs
+# endif
+
+# include <sys/types.h>
+# include <sys/stat.h>
+#else
+# include <mntent.h>
+# include <sys/stat.h>
+#endif
 
 mpeg3_fs_t* mpeg3_new_fs(char *path)
 {
@@ -215,16 +238,26 @@ void mpeg3io_complete_path(char *complet
 
 int mpeg3io_device(char *path, char *device)
 {
+#if defined(__NetBSD__) || defined(__DragonFly__) || (defined(__APPLE__) && defined(__MACH__))
+	struct statfs file_st;
+
+	if (statfs(path, &file_st) < 0)
+#else
+
 	struct stat64 file_st, device_st;
     struct mntent *mnt;
 	FILE *fp;
 
 	if(stat64(path, &file_st) < 0)
+#endif
 	{
 		perror("mpeg3io_device");
 		return 1;
 	}
 
+#if defined(__NetBSD__) || defined(__DragonFly__) || (defined(__APPLE__) && defined(__MACH__))
+	strncpy(device, file_st.f_mntfromname, MPEG3_STRLEN);
+#else
 	fp = setmntent(MOUNTED, "r");
     while(fp && (mnt = getmntent(fp)))
 	{
@@ -236,6 +269,7 @@ int mpeg3io_device(char *path, char *dev
 		}
 	}
 	endmntent(fp);
+#endif
 
 	return 0;
 }
