$NetBSD: patch-ad,v 1.2 2009/01/17 10:11:14 adam Exp $

--- dlls/iphlpapi/ipstats.c.orig	2009-01-16 17:28:07.000000000 +0100
+++ dlls/iphlpapi/ipstats.c
@@ -28,6 +28,10 @@
 #include <stdlib.h>
 #include <string.h>
 #include <sys/types.h>
+#if defined(__NetBSD__)
+#include <sys/param.h>
+#endif
+#include <unistd.h>
 #ifdef HAVE_ALIAS_H
 #include <alias.h>
 #endif
@@ -467,7 +471,7 @@ DWORD getICMPStats(MIB_ICMP *stats)
 
 DWORD getIPStats(PMIB_IPSTATS stats)
 {
-#if defined(HAVE_SYS_SYSCTL_H) && defined(IPCTL_STATS)
+#if defined(HAVE_SYS_SYSCTL_H) && defined(IPCTL_STATS) && !defined(__NetBSD__)
   int mib[] = {CTL_NET, PF_INET, IPPROTO_IP, IPCTL_STATS};
 #define MIB_LEN (sizeof(mib) / sizeof(mib[0]))
   int ip_ttl, ip_forwarding;
@@ -636,7 +640,7 @@ DWORD getIPStats(PMIB_IPSTATS stats)
 
 DWORD getTCPStats(MIB_TCPSTATS *stats)
 {
-#if defined(HAVE_SYS_SYSCTL_H) && defined(UDPCTL_STATS)
+#if defined(HAVE_SYS_SYSCTL_H) && defined(UDPCTL_STATS) && !defined(__NetBSD__)
 #ifndef TCPTV_MIN  /* got removed in Mac OS X for some reason */
 #define TCPTV_MIN 2
 #define TCPTV_REXMTMAX 128
@@ -773,7 +777,7 @@ DWORD getTCPStats(MIB_TCPSTATS *stats)
 
 DWORD getUDPStats(MIB_UDPSTATS *stats)
 {
-#if defined(HAVE_SYS_SYSCTL_H) && defined(UDPCTL_STATS)
+#if defined(HAVE_SYS_SYSCTL_H) && defined(UDPCTL_STATS) && !defined(__NetBSD__)
   int mib[] = {CTL_NET, PF_INET, IPPROTO_UDP, UDPCTL_STATS};
 #define MIB_LEN (sizeof(mib) / sizeof(mib[0]))
   struct udpstat udp_stat;
@@ -1015,7 +1019,11 @@ DWORD getNumRoutes(void)
 
       /* Ignore all entries except for gateway routes which aren't
          multicast */
+#if !defined(RTF_MULTICAST)
+      if (!(rtm->rtm_flags & RTF_GATEWAY))
+#else
       if (!(rtm->rtm_flags & RTF_GATEWAY) || (rtm->rtm_flags & RTF_MULTICAST))
+#endif
          continue;
 
       RouteCount++;
@@ -1091,8 +1099,12 @@ DWORD getRouteTable(PMIB_IPFORWARDTABLE 
 
           /* Ignore all entries except for gateway routes which aren't
              multicast */
+#if !defined(RTF_MULTICAST)
+          if (!(rtm->rtm_flags & RTF_GATEWAY))
+#else
           if (!(rtm->rtm_flags & RTF_GATEWAY) ||
               (rtm->rtm_flags & RTF_MULTICAST))
+#endif
              continue;
 
           memset (&table->table[table->dwNumEntries], 0,
@@ -1253,7 +1265,7 @@ DWORD getRouteTable(PMIB_IPFORWARDTABLE 
 
 DWORD getNumArpEntries(void)
 {
-#if defined(HAVE_SYS_SYSCTL_H) && defined(NET_RT_DUMP)
+#if defined(HAVE_SYS_SYSCTL_H) && defined(NET_RT_DUMP) && !defined(__NetBSD__)
   int mib[] = {CTL_NET, PF_ROUTE, 0, AF_INET, NET_RT_FLAGS, RTF_LLINFO};
 #define MIB_LEN (sizeof(mib) / sizeof(mib[0]))
   DWORD arpEntries = 0;
@@ -1309,7 +1321,7 @@ DWORD getArpTable(PMIB_IPNETTABLE *ppIpN
     if (numEntries > 1)
       size += (numEntries - 1) * sizeof(MIB_IPNETROW);
     table = HeapAlloc(heap, flags, size);
-#if defined(HAVE_SYS_SYSCTL_H) && defined(NET_RT_DUMP)
+#if defined(HAVE_SYS_SYSCTL_H) && defined(NET_RT_DUMP) && !defined(__NetBSD__)
     if (table)
     {
       int mib[] = {CTL_NET, PF_ROUTE, 0, AF_INET, NET_RT_FLAGS, RTF_LLINFO};
