# $NetBSD: Makefile,v 1.93 2007/10/30 13:44:22 martti Exp $

DISTNAME=	squirrelmail-1.4.11
#PKGREVISION=	1
CATEGORIES=	mail www
MASTER_SITES=	${MASTER_SITE_SOURCEFORGE:=squirrelmail/}
EXTRACT_SUFX=	.tar.bz2

MAINTAINER=	martti@NetBSD.org
HOMEPAGE=	http://www.squirrelmail.org/
COMMENT=	PHP webmail package
LICENSE=	gnu-gpl-v2

CONFLICTS=	sq-attachment-handlers-[0-9]*
CONFLICTS+=	sq-squirrelspell-[0-9]*
CONFLICTS+=	ja-squirrelspell-[0-9]*
CONFLICTS+=	ja-squirrelmail-[0-9]*

DEPENDS+=	${PHP_PKG_PREFIX}-gettext>=4.3.3:../../devel/php-gettext

USE_LANGUAGES=	# empty
NO_BUILD=	yes
USE_TOOLS+=	perl:run
REPLACE_PERL+=	config/conf.pl

PKG_GROUPS_VARS+=	APACHE_GROUP
PKG_USERS_VARS+=	APACHE_USER
BUILD_DEFS+=		VARBASE

.include "options.mk"

PKG_SYSCONFSUBDIR?=	httpd
MESSAGE_SUBST+=		PKG_SYSCONFDIR=${PKG_SYSCONFDIR:Q}

EGDIR=			${PREFIX}/share/examples/squirrelmail
SMDIR=			${PREFIX}/share/squirrelmail
DATADIR=		${VARBASE}/spool/squirrelmail
ATTACHMENTS_DIR=	${DATADIR}/attachments
USER_PREFS_DIR=		${DATADIR}/data

MESSAGE_SUBST+=		SMDIR=${SMDIR:Q}
FILES_SUBST+=		SMDIR=${SMDIR:Q}

CONF_FILES=		${SMDIR:Q}/config/config_default.php \
			${SMDIR:Q}/config/config.php
CONF_FILES+=		${SMDIR:Q}/data/default_pref \
			${DATADIR:Q}/data/default_pref
CONF_FILES+=		${EGDIR:Q}/squirrelmail.conf \
			${PKG_SYSCONFDIR:Q}/squirrelmail.conf

REQD_DIRS+=		${SMDIR:Q} ${SMDIR:Q}/config

OWN_DIRS=		${DATADIR}
OWN_DIRS_PERMS=		${ATTACHMENTS_DIR} ${ROOT_USER} ${APACHE_GROUP} 730
OWN_DIRS_PERMS+=	${USER_PREFS_DIR} ${APACHE_USER} ${APACHE_GROUP} 755

SUBST_CLASSES+=		paths
SUBST_FILES.paths=	${WRKDIR:Q}/squirrelmail.conf.dist
SUBST_FILES.paths+=	config/config_default.php
SUBST_SED.paths+=	-e 's,@PREFIX@,${PREFIX},g'
SUBST_SED.paths+=	-e 's,@ATTACHMENTS_DIR@,${ATTACHMENTS_DIR},g'
SUBST_SED.paths+=	-e 's,@USER_PREFS_DIR@,${USER_PREFS_DIR},g'
SUBST_SED.paths+=	-e 's,@SMDIR@,${SMDIR},g'
SUBST_STAGE.paths=	post-patch

INSTALLATION_DIRS=	${PKGMANDIR}/man8
INSTALLATION_DIRS+=	share/examples/squirrelmail
INSTALLATION_DIRS+=	share/squirrelmail

post-extract:
	cp ${FILESDIR:Q}/squirrelmail.conf.dist \
		${WRKDIR:Q}/squirrelmail.conf.dist

pre-configure:
	find ${WRKSRC:Q} \( -name '*.orig*' -o -name '.cvsignore' \) \
		-exec rm -f {} \;
# currently, we use iso_2022_jp.php in squirrelmail-decode package.
#
	rm -f ${WRKSRC}/functions/decode/iso_2022_jp.php

do-install:
	${INSTALL_DATA} ${WRKDIR:Q}/squirrelmail.conf.dist ${EGDIR:Q}/squirrelmail.conf
	cp -R ${WRKSRC:Q}/* ${SMDIR:Q}
	chown -R ${SHAREOWN}:${SHAREGRP} ${SMDIR}
	find ${SMDIR} -type d -exec chmod ${PKGDIRMODE} {} \;
	find ${SMDIR} -type f -exec chmod ${SHAREMODE} {} \;
	chmod a+x ${SMDIR:Q}/config/conf.pl
	${INSTALL_DATA} ${WRKSRC:Q}/data/index.php ${USER_PREFS_DIR:Q}/
	${INSTALL_DATA} ${WRKSRC:Q}/data/.htaccess ${USER_PREFS_DIR:Q}/
	mv ${PREFIX}/share/squirrelmail/contrib/conf.pl.8 \
	  ${PREFIX}/${PKGMANDIR}/man8/squirrelmail-conf.pl.8

.include "../../lang/php/phpversion.mk"
.include "../../mk/bsd.pkg.mk"
